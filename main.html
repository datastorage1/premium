<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application Hub</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Additional styles for file display */
        #user-files, #shared-files {
            margin-top: 30px;
        }
        
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .file-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background-color: #f9f9f9;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .file-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        
        .file-actions button {
            padding: 5px 10px;
            cursor: pointer;
        }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 2s linear infinite;
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        #logout-btn {
            padding: 8px 15px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .server-status {
            text-align: center;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            background-color: #d4edda;
            color: #155724;
            display: block;
        }
        
        .shared-file-indicator {
            display: inline-block;
            background-color: #007bff;
            color: white;
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
        }
        
        .tab.active {
            background-color: #f9f9f9;
            border-color: #ddd;
            border-bottom-color: #f9f9f9;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .share-checkbox {
            margin-top: 15px;
            display: flex;
            align-items: center;
        }
        
        .share-checkbox input {
            margin-right: 10px;
        }
        
        .share-checkbox label {
            font-weight: bold;
        }
        
        /* Upload progress bar styles */
        .upload-progress-container {
            margin-top: 15px;
            display: none;
        }
        
        .upload-progress-bar {
            height: 20px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .upload-progress-bar-fill {
            height: 100%;
            background-color: #4CAF50;
            border-radius: 4px;
            transition: width 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .product-image-preview {
            max-width: 200px;
            max-height: 200px;
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: none;
        }
        
        .product-image-container {
            margin-bottom: 15px;
        }
        
        .file-item img {
            max-width: 100%;
            max-height: 150px;
            display: block;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        
        .category-container {
            margin-bottom: 15px;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        
        .category-container h4 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 16px;
            color: #333;
        }
        
        .category-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .category-option {
            display: flex;
            align-items: center;
        }
        
        .category-option input {
            margin-right: 10px;
        }
        
        .category-badge {
            display: inline-block;
            padding: 3px 8px;
            font-size: 12px;
            font-weight: bold;
            border-radius: 12px;
            margin-left: 8px;
            color: white;
        }
        
        .category-windows {
            background-color: #0078d7;
        }
        
        .category-android {
            background-color: #a4c639;
        }
        
        .category-os {
            background-color: #e74c3c;
        }
        
        .search-container {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .search-container input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .search-container button {
            margin-left: 10px;
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .search-container button:hover {
            background-color: #45a049;
        }
        
        .no-results {
            text-align: center;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 4px;
            margin-top: 20px;
        }
        
        /* Category filter styles */
        .category-filter {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .category-filter button {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: #f5f5f5;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .category-filter button.active {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        /* Edit modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close-modal:hover {
            color: #000;
        }
        
        .category-group {
            margin-bottom: 30px;
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
        }
        
        .category-group h3 {
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid;
        }
        
        .windows-category h3 {
            border-color: #0078d7;
        }
        
        .android-category h3 {
            border-color: #a4c639;
        }
        
        .os-category h3 {
            border-color: #e74c3c;
        }
    </style>
</head>
<body>
    <header>
        <div class="user-info">
            <h1>Welcome to the Application Hub</h1>
            <button id="logout-btn">Logout</button>
        </div>
        <p>Your place for premium Windows applications, for free!</p>
        <p id="user-welcome">Loading user information...</p>
    </header>
    
    <div class="server-status" id="serverStatus">
        âœ“ Local storage mode active
    </div>

    <main>
        <section id="file-management">
            <h2>Manage Files</h2>
            
            <div class="tabs">
                <div class="tab active" data-tab="upload">Upload Files</div>
                <div class="tab" data-tab="my-files">My Files</div>
                <div class="tab" data-tab="shared-files">Shared Files</div>
            </div>
            
            <div id="upload-section" class="tab-content active" data-tab="upload">
                <h3>Upload Your File</h3>
                <form id="upload-form">
                    <div>
                        <label for="file-name">File Name:</label>
                        <input type="text" id="file-name" name="fileName" required>
                    </div>
                    <div>
                        <label for="file-description">Description:</label>
                        <textarea id="file-description" name="fileDescription" rows="3" required></textarea>
                    </div>
                    <div class="product-image-container">
                        <label for="product-image">Product Image (required):</label>
                        <input type="file" id="product-image" name="productImage" accept="image/*" required>
                        <img id="product-image-preview" class="product-image-preview">
                    </div>
                    <div class="category-container">
                        <h4>Select Category (required):</h4>
                        <div class="category-options">
                            <div class="category-option">
                                <input type="radio" id="category-windows" name="category" value="windows" required>
                                <label for="category-windows">Windows Software</label>
                            </div>
                            <div class="category-option">
                                <input type="radio" id="category-android" name="category" value="android">
                                <label for="category-android">Android Application</label>
                            </div>
                            <div class="category-option">
                                <input type="radio" id="category-os" name="category" value="os">
                                <label for="category-os">Operating Systems</label>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="file-upload">Select file to upload:</label>
                        <input type="file" id="file-upload" name="fileUpload" required>
                    </div>
                    <div class="share-checkbox">
                        <input type="checkbox" id="share-with-all" name="shareWithAll">
                        <label for="share-with-all">Share this file with all users</label>
                    </div>
                    <div class="upload-progress-container" id="upload-progress-container">
                        <p>Uploading: <span id="upload-progress-text">0%</span></p>
                        <div class="upload-progress-bar">
                            <div class="upload-progress-bar-fill" id="upload-progress-bar-fill" style="width: 0%">0%</div>
                        </div>
                    </div>
                    <button type="submit">Upload File <span id="upload-loader" class="loader hidden"></span></button>
                </form>
            </div>
            
            <div id="user-files" class="tab-content" data-tab="my-files">
                <h3>Your Uploaded Files</h3>
                <div class="search-container">
                    <input type="text" id="my-files-search" placeholder="Search your files by name, description or type...">
                    <button id="my-files-search-btn">Search</button>
                </div>
                <div id="files-loader" class="loader hidden"></div>
                <div class="file-grid" id="files-container">
                    <!-- Files will be dynamically loaded here -->
                </div>
            </div>
            
            <div id="shared-files" class="tab-content" data-tab="shared-files">
                <h3>Files Shared By All Users</h3>
                <div class="search-container">
                    <input type="text" id="shared-files-search" placeholder="Search shared files by name, description or type...">
                    <button id="shared-files-search-btn">Search</button>
                </div>
                <div class="category-filter">
                    <button class="filter-btn active" data-category="all">All Categories</button>
                    <button class="filter-btn" data-category="windows">Windows Software</button>
                    <button class="filter-btn" data-category="android">Android Applications</button>
                    <button class="filter-btn" data-category="os">Operating Systems</button>
                </div>
                <div id="shared-files-loader" class="loader hidden"></div>
                <div id="shared-files-container">
                    <!-- Shared files will be dynamically loaded here -->
                </div>
            </div>
        </section>
    </main>

    <!-- Edit File Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h3>Edit File Information</h3>
            <form id="edit-form">
                <input type="hidden" id="edit-file-id">
                <div>
                    <label for="edit-file-name">File Name:</label>
                    <input type="text" id="edit-file-name" name="editFileName" required>
                </div>
                <div>
                    <label for="edit-file-description">Description:</label>
                    <textarea id="edit-file-description" name="editFileDescription" rows="3" required></textarea>
                </div>
                <div class="product-image-container">
                    <label for="edit-product-image">Product Image:</label>
                    <input type="file" id="edit-product-image" name="editProductImage" accept="image/*">
                    <img id="edit-product-image-preview" class="product-image-preview">
                    <p><small>Leave empty to keep current image</small></p>
                </div>
                <div class="category-container">
                    <h4>Select Category:</h4>
                    <div class="category-options">
                        <div class="category-option">
                            <input type="radio" id="edit-category-windows" name="editCategory" value="windows" required>
                            <label for="edit-category-windows">Windows Software</label>
                        </div>
                        <div class="category-option">
                            <input type="radio" id="edit-category-android" name="editCategory" value="android">
                            <label for="edit-category-android">Android Application</label>
                        </div>
                        <div class="category-option">
                            <input type="radio" id="edit-category-os" name="editCategory" value="os">
                            <label for="edit-category-os">Operating Systems</label>
                        </div>
                    </div>
                </div>
                <div class="share-checkbox">
                    <input type="checkbox" id="edit-share-with-all" name="editShareWithAll">
                    <label for="edit-share-with-all">Share this file with all users</label>
                </div>
                <button type="submit">Update File</button>
            </form>
        </div>
    </div>

    <footer>
        <p>&copy; 2024 Application Hub. All rights reserved.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            const user = JSON.parse(sessionStorage.getItem('user'));
            if (!user) {
                alert('Please log in to access this page');
                window.location.href = 'index.html';
                return;
            }
            
            // Update welcome message
            document.getElementById('user-welcome').textContent = `Welcome, ${user.fullName}!`;
            
            // Handle logout
            document.getElementById('logout-btn').addEventListener('click', function() {
                sessionStorage.removeItem('user');
                window.location.href = 'index.html';
            });
            
            // Initialize files array in localStorage if it doesn't exist
            if (!localStorage.getItem('files')) {
                localStorage.setItem('files', JSON.stringify([]));
            }
            
            // Tab navigation
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs and content
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    this.classList.add('active');
                    
                    // Show corresponding content
                    const tabName = this.getAttribute('data-tab');
                    document.querySelector(`.tab-content[data-tab="${tabName}"]`).classList.add('active');
                    
                    // Load files if needed
                    if (tabName === 'my-files') {
                        loadUserFiles();
                    } else if (tabName === 'shared-files') {
                        loadSharedFiles();
                    }
                });
            });
            
            // Load user files initially
            loadUserFiles();
            loadSharedFiles();
            
            // Set up search functionality
            document.getElementById('my-files-search-btn').addEventListener('click', function() {
                const searchTerm = document.getElementById('my-files-search').value.trim().toLowerCase();
                searchUserFiles(searchTerm);
            });
            
            document.getElementById('my-files-search').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    const searchTerm = this.value.trim().toLowerCase();
                    searchUserFiles(searchTerm);
                }
            });
            
            document.getElementById('shared-files-search-btn').addEventListener('click', function() {
                const searchTerm = document.getElementById('shared-files-search').value.trim().toLowerCase();
                searchSharedFiles(searchTerm);
            });
            
            document.getElementById('shared-files-search').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    const searchTerm = this.value.trim().toLowerCase();
                    searchSharedFiles(searchTerm);
                }
            });
            
            // Handle file upload
            document.getElementById('upload-form').addEventListener('submit', function(event) {
                event.preventDefault();
                
                const fileInput = document.getElementById('file-upload');
                const productImageInput = document.getElementById('product-image');
                const fileName = document.getElementById('file-name').value;
                const fileDescription = document.getElementById('file-description').value;
                const shareWithAll = document.getElementById('share-with-all').checked;
                
                // Get selected category
                const categoryRadios = document.getElementsByName('category');
                let selectedCategory = null;
                
                for (const radio of categoryRadios) {
                    if (radio.checked) {
                        selectedCategory = radio.value;
                        break;
                    }
                }
                
                if (!selectedCategory) {
                    alert('Please select a category');
                    return;
                }
                
                if (!fileInput.files[0]) {
                    alert('Please select a file to upload');
                    return;
                }
                
                if (!productImageInput.files[0]) {
                    alert('Please select a product image');
                    return;
                }
                
                const uploadLoader = document.getElementById('upload-loader');
                uploadLoader.classList.remove('hidden');
                
                // Show progress container
                const progressContainer = document.getElementById('upload-progress-container');
                const progressBarFill = document.getElementById('upload-progress-bar-fill');
                const progressText = document.getElementById('upload-progress-text');
                progressContainer.style.display = 'block';
                progressBarFill.style.width = '0%';
                progressBarFill.textContent = '0%';
                progressText.textContent = '0%';
                
                // Simulate upload progress
                let progress = 0;
                const simulateProgress = setInterval(() => {
                    progress += 5;
                    if (progress > 90) { // Only go to 90% with simulation, final 10% when complete
                        clearInterval(simulateProgress);
                    }
                    updateProgress(progress);
                }, 200);
                
                function updateProgress(percent) {
                    progressBarFill.style.width = percent + '%';
                    progressBarFill.textContent = percent + '%';
                    progressText.textContent = percent + '%';
                }
                
                // Create a file object (simulating server upload)
                const file = fileInput.files[0];
                const productImage = productImageInput.files[0];
                
                // First read product image
                const imageReader = new FileReader();
                imageReader.onload = function(imgEvent) {
                    const productImageData = imgEvent.target.result;
                    
                    // Then read the main file
                    const fileReader = new FileReader();
                    fileReader.onload = function(fileEvent) {
                        // Simulate completed upload
                        clearInterval(simulateProgress);
                        updateProgress(100);
                        
                        // Get existing files
                        const files = JSON.parse(localStorage.getItem('files'));
                        
                        // Create new file record with base64 data
                        const newFile = {
                            id: Date.now().toString(),
                            userId: user.id,
                            uploader: user.fullName,
                            filename: Date.now() + '-' + file.name,
                            originalName: file.name,
                            displayName: fileName,
                            description: fileDescription,
                            fileSize: file.size,
                            fileType: file.type,
                            fileData: fileEvent.target.result,
                            productImage: productImageData,
                            uploadDate: new Date().toISOString(),
                            shared: shareWithAll,
                            category: selectedCategory
                        };
                        
                        // Add file to array and save
                        files.push(newFile);
                        localStorage.setItem('files', JSON.stringify(files));
                        
                        // Reset form and update file list
                        setTimeout(() => {
                            document.getElementById('upload-form').reset();
                            document.getElementById('product-image-preview').style.display = 'none';
                            progressContainer.style.display = 'none';
                            loadUserFiles();
                            loadSharedFiles();
                            uploadLoader.classList.add('hidden');
                            
                            alert('File uploaded successfully!');
                            
                            // Switch to appropriate tab based on sharing choice
                            if (shareWithAll) {
                                document.querySelector('.tab[data-tab="shared-files"]').click();
                            } else {
                                document.querySelector('.tab[data-tab="my-files"]').click();
                            }
                        }, 500); // Short delay to show 100% completion
                    };
                    
                    fileReader.onerror = function() {
                        clearInterval(simulateProgress);
                        progressContainer.style.display = 'none';
                        alert('Error reading file');
                        uploadLoader.classList.add('hidden');
                    };
                    
                    // Set up progress handling for large files
                    fileReader.onprogress = function(e) {
                        if (e.lengthComputable) {
                            const percentLoaded = Math.round((e.loaded / e.total) * 100);
                            if (percentLoaded > 90) { // Blend with our simulation
                                updateProgress(percentLoaded);
                            }
                        }
                    };
                    
                    // Read file as data URL (base64)
                    fileReader.readAsDataURL(file);
                };
                
                imageReader.onerror = function() {
                    clearInterval(simulateProgress);
                    progressContainer.style.display = 'none';
                    alert('Error reading product image');
                    uploadLoader.classList.add('hidden');
                };
                
                // Read product image as data URL (base64)
                imageReader.readAsDataURL(productImage);
            });
            
            // Preview product image when selected
            document.getElementById('product-image').addEventListener('change', function() {
                const preview = document.getElementById('product-image-preview');
                const file = this.files[0];
                
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.style.display = 'none';
                }
            });
            
            // Preview edit product image when selected
            document.getElementById('edit-product-image').addEventListener('change', function() {
                const preview = document.getElementById('edit-product-image-preview');
                const file = this.files[0];
                
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Handle edit form submission
            document.getElementById('edit-form').addEventListener('submit', function(event) {
                event.preventDefault();
                
                const fileId = document.getElementById('edit-file-id').value;
                const fileName = document.getElementById('edit-file-name').value;
                const fileDescription = document.getElementById('edit-file-description').value;
                const shareWithAll = document.getElementById('edit-share-with-all').checked;
                const productImageInput = document.getElementById('edit-product-image');
                
                // Get selected category
                const categoryRadios = document.getElementsByName('editCategory');
                let selectedCategory = null;
                
                for (const radio of categoryRadios) {
                    if (radio.checked) {
                        selectedCategory = radio.value;
                        break;
                    }
                }
                
                if (!selectedCategory) {
                    alert('Please select a category');
                    return;
                }
                
                // Get files from localStorage
                const files = JSON.parse(localStorage.getItem('files'));
                const fileIndex = files.findIndex(f => f.id === fileId);
                
                if (fileIndex !== -1) {
                    // Update file object properties
                    files[fileIndex].displayName = fileName;
                    files[fileIndex].description = fileDescription;
                    files[fileIndex].shared = shareWithAll;
                    files[fileIndex].category = selectedCategory;
                    
                    // If a new product image was uploaded, process it
                    if (productImageInput.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            // Update product image
                            files[fileIndex].productImage = e.target.result;
                            
                            // Save updated files to localStorage
                            localStorage.setItem('files', JSON.stringify(files));
                            
                            // Close modal and refresh file lists
                            closeEditModal();
                            loadUserFiles();
                            loadSharedFiles();
                            
                            alert('File updated successfully!');
                        };
                        reader.readAsDataURL(productImageInput.files[0]);
                    } else {
                        // No new image, save other updates
                        localStorage.setItem('files', JSON.stringify(files));
                        
                        // Close modal and refresh file lists
                        closeEditModal();
                        loadUserFiles();
                        loadSharedFiles();
                        
                        alert('File updated successfully!');
                    }
                }
                
                // After file is updated, ensure we refresh both tabs
                setTimeout(() => {
                    // Refresh the "My Files" tab
                    loadUserFiles();
                    
                    // Make sure we refresh the shared files tab as well
                    loadSharedFiles();
                }, 100);
            });
            
            // Close modal when clicking the X
            document.querySelector('.close-modal').addEventListener('click', closeEditModal);
            
            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('edit-modal');
                if (event.target === modal) {
                    closeEditModal();
                }
            });
            
            // Function to close edit modal
            function closeEditModal() {
                document.getElementById('edit-modal').style.display = 'none';
            }
            
            // Function to open edit modal and populate with file data
            function openEditModal(fileId) {
                const files = JSON.parse(localStorage.getItem('files'));
                const file = files.find(f => f.id === fileId);
                
                if (file) {
                    // Populate form fields with file data
                    document.getElementById('edit-file-id').value = file.id;
                    document.getElementById('edit-file-name').value = file.displayName || file.originalName;
                    document.getElementById('edit-file-description').value = file.description || '';
                    document.getElementById('edit-share-with-all').checked = file.shared;
                    
                    // Select the correct category radio button
                    if (file.category) {
                        document.getElementById(`edit-category-${file.category}`).checked = true;
                    }
                    
                    // Display current product image
                    const preview = document.getElementById('edit-product-image-preview');
                    preview.src = file.productImage;
                    preview.style.display = 'block';
                    
                    // Show modal
                    document.getElementById('edit-modal').style.display = 'block';
                }
            }
            
            // Search user files function
            function searchUserFiles(searchTerm) {
                const filesContainer = document.getElementById('files-container');
                const filesLoader = document.getElementById('files-loader');
                
                filesContainer.innerHTML = '';
                filesLoader.classList.remove('hidden');
                
                // Get files from localStorage
                const files = JSON.parse(localStorage.getItem('files'));
                
                // Filter files for current user and matching search term
                let userFiles = files.filter(file => file.userId === user.id);
                
                // If there's a search term, filter by it
                if (searchTerm) {
                    userFiles = userFiles.filter(file => 
                        (file.displayName && file.displayName.toLowerCase().includes(searchTerm)) || 
                        (file.originalName && file.originalName.toLowerCase().includes(searchTerm)) || 
                        (file.description && file.description.toLowerCase().includes(searchTerm)) || 
                        (file.fileType && file.fileType.toLowerCase().includes(searchTerm)) ||
                        (file.category === 'windows' && ('windows software').includes(searchTerm)) ||
                        (file.category === 'android' && ('android application' || 'android app').includes(searchTerm)) ||
                        (file.category === 'os' && ('operating system' || 'os').includes(searchTerm))
                    );
                }
                
                setTimeout(() => {
                    if (userFiles.length === 0) {
                        if (searchTerm) {
                            filesContainer.innerHTML = `<div class="no-results">No files found matching "${searchTerm}"</div>`;
                        } else {
                            filesContainer.innerHTML = '<p>You have not uploaded any files yet.</p>';
                        }
                    } else {
                        userFiles.forEach(file => {
                            const fileElement = document.createElement('div');
                            fileElement.className = 'file-item';
                            
                            let fileHeader = `<h4>${file.displayName || file.originalName}`;
                            if (file.shared) {
                                fileHeader += `<span class="shared-file-indicator">Shared</span>`;
                            }
                            
                            // Add category badge
                            if (file.category) {
                                let categoryClass = '';
                                let categoryText = '';
                                
                                switch(file.category) {
                                    case 'windows':
                                        categoryClass = 'category-windows';
                                        categoryText = 'Windows Software';
                                        break;
                                    case 'android':
                                        categoryClass = 'category-android';
                                        categoryText = 'Android App';
                                        break;
                                    case 'os':
                                        categoryClass = 'category-os';
                                        categoryText = 'OS';
                                        break;
                                }
                                
                                fileHeader += `<span class="category-badge ${categoryClass}">${categoryText}</span>`;
                            }
                            
                            fileHeader += `</h4>`;
                            
                            fileElement.innerHTML = `
                                ${fileHeader}
                                <img src="${file.productImage}" alt="Product Image">
                                <p>${file.description || ''}</p>
                                <p>Type: ${file.fileType}</p>
                                <p>Size: ${formatFileSize(file.fileSize)}</p>
                                <p>Uploaded: ${new Date(file.uploadDate).toLocaleString()}</p>
                                <div class="file-actions">
                                    <button class="download-btn" data-id="${file.id}">Download</button>
                                    <button class="edit-btn" data-id="${file.id}">Edit</button>
                                    <button class="delete-btn" data-id="${file.id}">Delete</button>
                                </div>
                            `;
                            filesContainer.appendChild(fileElement);
                        });
                        
                        // Add event listeners to download buttons
                        document.querySelectorAll('#files-container .download-btn').forEach(button => {
                            button.addEventListener('click', function() {
                                const fileId = this.getAttribute('data-id');
                                downloadFile(fileId);
                            });
                        });
                        
                        // Add event listeners to edit buttons
                        document.querySelectorAll('#files-container .edit-btn').forEach(button => {
                            button.addEventListener('click', function() {
                                const fileId = this.getAttribute('data-id');
                                openEditModal(fileId);
                            });
                        });
                        
                        // Add event listeners to delete buttons
                        document.querySelectorAll('#files-container .delete-btn').forEach(button => {
                            button.addEventListener('click', function() {
                                const fileId = this.getAttribute('data-id');
                                deleteFile(fileId);
                            });
                        });
                    }
                    
                    filesLoader.classList.add('hidden');
                }, 500); // Small delay to show loading indicator
            }
            
            // Search shared files function
            function searchSharedFiles(searchTerm) {
                const sharedFilesContainer = document.getElementById('shared-files-container');
                const sharedFilesLoader = document.getElementById('shared-files-loader');
                
                sharedFilesContainer.innerHTML = '';
                sharedFilesLoader.classList.remove('hidden');
                
                // Get files from localStorage
                const files = JSON.parse(localStorage.getItem('files')) || [];
                
                // Filter files that are shared - ensure we're correctly checking the shared flag
                let sharedFiles = files.filter(file => file.shared === true);
                
                console.log('Total files:', files.length);
                console.log('Shared files found:', sharedFiles.length);
                
                // Get the active category filter
                const activeFilter = document.querySelector('.filter-btn.active').getAttribute('data-category');
                
                // Apply category filter if not 'all'
                if (activeFilter !== 'all') {
                    sharedFiles = sharedFiles.filter(file => file.category === activeFilter);
                }
                
                // If there's a search term, filter by it
                if (searchTerm) {
                    sharedFiles = sharedFiles.filter(file => 
                        (file.displayName && file.displayName.toLowerCase().includes(searchTerm)) || 
                        (file.originalName && file.originalName.toLowerCase().includes(searchTerm)) || 
                        (file.description && file.description.toLowerCase().includes(searchTerm)) || 
                        (file.fileType && file.fileType.toLowerCase().includes(searchTerm)) ||
                        (file.uploader && file.uploader.toLowerCase().includes(searchTerm))
                    );
                }
                
                setTimeout(() => {
                    if (sharedFiles.length === 0) {
                        if (searchTerm) {
                            sharedFilesContainer.innerHTML = `<div class="no-results">No shared files found matching "${searchTerm}"</div>`;
                        } else if (activeFilter !== 'all') {
                            sharedFilesContainer.innerHTML = `<div class="no-results">No shared files found in the "${activeFilter}" category</div>`;
                        } else {
                            sharedFilesContainer.innerHTML = '<p>There are no shared files available.</p>';
                        }
                    } else {
                        // If we're showing all categories, group by category
                        if (activeFilter === 'all') {
                            // Group files by category
                            const categorizedFiles = {
                                windows: sharedFiles.filter(file => file.category === 'windows'),
                                android: sharedFiles.filter(file => file.category === 'android'),
                                os: sharedFiles.filter(file => file.category === 'os')
                            };
                            
                            // Create category sections
                            ['windows', 'android', 'os'].forEach(category => {
                                if (categorizedFiles[category].length > 0) {
                                    const categoryGroup = document.createElement('div');
                                    categoryGroup.className = `category-group ${category}-category`;
                                    
                                    let categoryTitle = '';
                                    switch(category) {
                                        case 'windows': categoryTitle = 'Windows Software'; break;
                                        case 'android': categoryTitle = 'Android Applications'; break;
                                        case 'os': categoryTitle = 'Operating Systems'; break;
                                    }
                                    
                                    categoryGroup.innerHTML = `<h3>${categoryTitle}</h3>`;
                                    const categoryGrid = document.createElement('div');
                                    categoryGrid.className = 'file-grid';
                                    
                                    renderSharedFilesInGrid(categorizedFiles[category], categoryGrid);
                                    
                                    categoryGroup.appendChild(categoryGrid);
                                    sharedFilesContainer.appendChild(categoryGroup);
                                }
                            });
                        } else {
                            // If a category is selected, just show a simple grid
                            const fileGrid = document.createElement('div');
                            fileGrid.className = 'file-grid';
                            renderSharedFilesInGrid(sharedFiles, fileGrid);
                            sharedFilesContainer.appendChild(fileGrid);
                        }
                        
                        // Add event listeners to download buttons
                        document.querySelectorAll('#shared-files-container .download-btn').forEach(button => {
                            button.addEventListener('click', function() {
                                const fileId = this.getAttribute('data-id');
                                downloadFile(fileId);
                            });
                        });
                        
                        // Add event listeners to edit buttons
                        document.querySelectorAll('#shared-files-container .edit-btn').forEach(button => {
                            button.addEventListener('click', function() {
                                const fileId = this.getAttribute('data-id');
                                openEditModal(fileId);
                            });
                        });
                        
                        // Add event listeners to delete buttons
                        document.querySelectorAll('#shared-files-container .delete-btn').forEach(button => {
                            button.addEventListener('click', function() {
                                const fileId = this.getAttribute('data-id');
                                deleteFile(fileId, true);
                            });
                        });
                    }
                    
                    sharedFilesLoader.classList.add('hidden');
                }, 500); // Small delay to show loading indicator
            }
            
            // Helper function to render shared files in a grid
            function renderSharedFilesInGrid(files, gridElement) {
                files.forEach(file => {
                    const fileElement = document.createElement('div');
                    fileElement.className = 'file-item';
                    
                    const isOwnFile = file.userId === user.id;
                    
                    let fileHeader = `<h4>${file.displayName || file.originalName}`;
                    if (file.shared) {
                        fileHeader += `<span class="shared-file-indicator">Shared</span>`;
                    }
                    
                    // Add category badge
                    if (file.category) {
                        let categoryClass = '';
                        let categoryText = '';
                        
                        switch(file.category) {
                            case 'windows':
                                categoryClass = 'category-windows';
                                categoryText = 'Windows Software';
                                break;
                            case 'android':
                                categoryClass = 'category-android';
                                categoryText = 'Android App';
                                break;
                            case 'os':
                                categoryClass = 'category-os';
                                categoryText = 'OS';
                                break;
                        }
                        
                        fileHeader += `<span class="category-badge ${categoryClass}">${categoryText}</span>`;
                    }
                    
                    fileHeader += `</h4>`;
                    
                    fileElement.innerHTML = `
                        ${fileHeader}
                        <img src="${file.productImage}" alt="Product Image">
                        <p>${file.description || ''}</p>
                        <p>Uploaded by: ${file.uploader || 'Unknown'}</p>
                        <p>Type: ${file.fileType}</p>
                        <p>Size: ${formatFileSize(file.fileSize)}</p>
                        <p>Uploaded: ${new Date(file.uploadDate).toLocaleString()}</p>
                        <div class="file-actions">
                            <button class="download-btn" data-id="${file.id}">Download</button>
                            ${isOwnFile ? `<button class="edit-btn" data-id="${file.id}">Edit</button>` : ''}
                            ${isOwnFile ? `<button class="delete-btn" data-id="${file.id}">Delete</button>` : ''}
                        </div>
                    `;
                    gridElement.appendChild(fileElement);
                });
            }
            
            // Function to download a file
            function downloadFile(fileId) {
                const files = JSON.parse(localStorage.getItem('files'));
                const file = files.find(f => f.id === fileId);
                
                if (file) {
                    // Create a temporary link and click it to download
                    const link = document.createElement('a');
                    link.href = file.fileData;
                    link.download = file.originalName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }
            
            // Function to delete a file
            function deleteFile(fileId, refreshShared = false) {
                if (confirm('Are you sure you want to delete this file?')) {
                    // Get files from localStorage
                    const files = JSON.parse(localStorage.getItem('files'));
                    
                    // Find index of file with matching ID
                    const fileIndex = files.findIndex(f => f.id === fileId);
                    
                    if (fileIndex !== -1) {
                        // Remove file and save
                        files.splice(fileIndex, 1);
                        localStorage.setItem('files', JSON.stringify(files));
                        
                        // Reload file lists
                        loadUserFiles();
                        if (refreshShared) {
                            loadSharedFiles();
                        }
                        
                        alert('File deleted successfully!');
                    }
                }
            }
            
            // Function to load user files
            function loadUserFiles() {
                const searchTerm = document.getElementById('my-files-search').value.trim().toLowerCase();
                searchUserFiles(searchTerm);
            }
            
            // Function to load shared files
            function loadSharedFiles() {
                const searchTerm = document.getElementById('shared-files-search').value.trim().toLowerCase();
                searchSharedFiles(searchTerm);
            }
            
            // Helper function to format file size
            function formatFileSize(bytes) {
                if (bytes < 1024) return bytes + ' bytes';
                else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
                else return (bytes / 1048576).toFixed(1) + ' MB';
            }
            
            // Setup category filter buttons
            document.querySelectorAll('.filter-btn').forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all filter buttons
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Reload shared files with the filter
                    loadSharedFiles();
                });
            });
        });
    </script>
</body>
</html> 
